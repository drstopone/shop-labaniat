<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <title>Saved Messages</title>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: auto; }
    #messages { border: 1px solid #ccc; padding: 10px; min-height: 200px; }
    .msg { border-bottom: 1px solid #eee; padding: 5px; }
  </style>
</head>
<body>
  <h2>Saved Messages</h2>
  <textarea id="text" placeholder="پیام خودت رو بنویس"></textarea><br>
  <input type="file" id="file"><br>
  <button id="saveBtn">ذخیره</button>

  <h3>پیام‌ها</h3>
  <div id="messages"></div>

<script>
  // ---------- تنظیم Supabase ----------
  const SUPABASE_URL = "https://YOUR-PROJECT.supabase.co";
  const SUPABASE_KEY = "YOUR-ANON-KEY"; // از Project Settings > API بگیر
  const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // ---------- ذخیره پیام ----------
  document.getElementById("saveBtn").onclick = async () => {
    const text = document.getElementById("text").value;
    const fileInput = document.getElementById("file");
    let fileUrl = null;

    if (fileInput.files.length > 0) {
      const file = fileInput.files[0];
      const { data, error } = await supabase.storage
        .from("uploads")
        .upload(Date.now() + "_" + file.name, file, { upsert: true });
      if (error) {
        alert("خطا در آپلود فایل: " + error.message);
        return;
      }
      fileUrl = `${SUPABASE_URL}/storage/v1/object/public/uploads/${data.path}`;
    }

    const { error: insertError } = await supabase
      .from("messages")
      .insert([{ text, file_url: fileUrl }]);

    if (insertError) {
      alert("خطا در ذخیره پیام: " + insertError.message);
    } else {
      document.getElementById("text").value = "";
      fileInput.value = "";
      loadMessages();
    }
  };

  // ---------- نمایش پیام‌ها ----------
  async function loadMessages() {
    const { data, error } = await supabase
      .from("messages")
      .select("*")
      .order("created_at", { ascending: false });
    if (error) {
      console.log(error);
      return;
    }
    const container = document.getElementById("messages");
    container.innerHTML = "";
    data.forEach(msg => {
      const div = document.createElement("div");
      div.className = "msg";
      div.innerHTML = `<p>${msg.text || ""}</p>` +
        (msg.file_url ? `<a href="${msg.file_url}" target="_blank">📎 فایل</a>` : "");
      container.appendChild(div);
    });
  }

  loadMessages();
</script>
</body>
</html>
