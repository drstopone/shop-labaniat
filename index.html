<!doctype html>
<html lang="fa">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>چت P2P با Room ID (Firebase Signaling)</title>
<style>
  body{font-family: Tahoma, Arial;direction: rtl;padding:16px;max-width:900px;margin:0 auto}
  input,button{padding:8px;margin:6px 0}
  #messages{border:1px solid #ddd;height:300px;overflow:auto;padding:8px;background:#fff}
  .msg{padding:6px;border-radius:6px;margin:6px 0;max-width:80%}
  .mine{background:#e0ffe0;margin-left:auto}
  .other{background:#f0f0f0;margin-right:auto}
  .row{display:flex;gap:8px;align-items:center}
  .small{font-size:12px;color:#666}
</style>
</head>
<body>
<h2>چت P2P با Room ID (Firebase)</h2>
<p class="small">برای اجرا: این فایل را در GitHub Pages آپلود کن. قبل از آن firebaseConfig را از کنسول Firebase جایگزین کن.</p>

<div>
  <label>نام شما:</label>
  <input id="name" placeholder="مثلاً: sina" />
</div>

<div class="row">
  <button id="createBtn">ساختن روم جدید (من Starter)</button>
  <input id="roomInput" placeholder="یا وارد کن: 6 رقم" style="width:120px"/>
  <button id="joinBtn">پیوستن به روم</button>
</div>

<div style="margin-top:8px">
  <div>کد روم فعلی: <strong id="roomId">—</strong></div>
  <div>وضعیت: <span id="status">قطع</span></div>
</div>

<hr/>

<div id="chatSection" style="display:none">
  <div id="messages" aria-live="polite"></div>
  <div class="row" style="margin-top:8px">
    <input id="txt" placeholder="پیام..." style="flex:1"/>
    <button id="send">ارسال</button>
  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

<script>
/* ====== جایگزین کن با firebaseConfig که از کنسول می‌گیری ====== */
const firebaseConfig = /* PASTE YOUR FIREBASE CONFIG HERE */;
/* مثال:
const firebaseConfig = {
  apiKey: "AIza....",
  authDomain: "your-project.firebaseapp.com",
  databaseURL: "https://your-project-default-rtdb.firebaseio.com",
  projectId: "your-project",
  storageBucket: "...",
  messagingSenderId: "...",
  appId: "1:..."
};
*/
if(!firebaseConfig || typeof firebaseConfig !== 'object'){
  alert('لطفاً firebaseConfig را در کد جایگزین کن (راهنما در پیام بالایی).');
}

const app = firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const cfg = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

let pc = null;
let dc = null;
let roomRef = null;
let roomId = null;
let isInitiator = false;

const statusEl = document.getElementById('status');
const roomIdEl = document.getElementById('roomId');
const chatSection = document.getElementById('chatSection');
const messagesEl = document.getElementById('messages');

function logStatus(s){ statusEl.textContent = s; }
function appendMessage(t, who='other'){
  const d = document.createElement('div');
  d.className = 'msg ' + (who === 'me' ? 'mine' : 'other');
  d.textContent = t;
  messagesEl.appendChild(d);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

function makeId(){
  return Math.floor(100000 + Math.random()*900000).toString(); // 6-digit
}

function createPeer(){
  pc = new RTCPeerConnection(cfg);
  pc.onicecandidate = event => {
    if(event.candidate){
      const c = event.candidate.toJSON();
      const candRef = roomRef.child(isInitiator ? 'offerCandidates' : 'answerCandidates').push();
      candRef.set(c).catch(console.error);
    }
  };
  pc.onconnectionstatechange = () => {
    logStatus(pc.connectionState);
  };
  pc.ondatachannel = ev => {
    dc = ev.channel;
    setupDC();
  };
}

function setupDC(){
  if(!dc) return;
  dc.onopen = () => {
    logStatus('connected');
    chatSection.style.display = 'block';
    appendMessage('** کانکشن باز شد **', 'other');
  };
  dc.onmessage = ev => {
    try{
      const payload = JSON.parse(ev.data);
      appendMessage(payload.name + ': ' + payload.msg, 'other');
    }catch(e){
      appendMessage(ev.data, 'other');
    }
  };
  dc.onclose = () => {
    logStatus('closed');
  };
}

/* ساخت روم (Initiator) */
document.getElementById('createBtn').onclick = async () => {
  const name = document.getElementById('name').value.trim() || 'me';
  isInitiator = true;
  roomId = makeId();
  roomIdEl.textContent = roomId;
  roomRef = db.ref('rooms/' + roomId);
  // پاک کن هر چیزی که از قبل بود (برای تست)
  await roomRef.remove().catch(()=>{});
  createPeer();
  dc = pc.createDataChannel('chat');
  setupDC();

  const offerDesc = await pc.createOffer();
  await pc.setLocalDescription(offerDesc);
  await roomRef.child('offer').set(offerDesc.toJSON());

  // گوش بده برای candidate های answer
  roomRef.child('answer').on('value', async snap => {
    const val = snap.val();
    if(val && !pc.currentRemoteDescription){
      await pc.setRemoteDescription(val);
    }
  });

  roomRef.child('answerCandidates').on('child_added', snap => {
    const c = snap.val();
    if(c) pc.addIceCandidate(c).catch(console.error);
  });

  roomRef.child('offerCandidates').on('child_added', snap => {
    // (optional) we could store our own candidates too; initiator already pushed them
  });

  logStatus('waiting for peer...');
  alert('روم ساخته شد. کد روم را برای دوستت بفرست: ' + roomId);
};

/* پیوستن به روم (Receiver) */
document.getElementById('joinBtn').onclick = async () => {
  const rid = document.getElementById('roomInput').value.trim();
  if(!rid || rid.length !== 6){ alert('یک کد 6 رقمی وارد کن'); return; }
  roomId = rid;
  roomIdEl.textContent = roomId;
  roomRef = db.ref('rooms/' + roomId);

  // بخون offer
  const snap = await roomRef.child('offer').get();
  if(!snap.exists()){ alert('روم پیدا نشد یا offer موجود نیست'); return; }

  isInitiator = false;
  createPeer();

  // set remote (offer)
  const offer = snap.val();
  await pc.setRemoteDescription(offer);

  // create answer
  const answerDesc = await pc.createAnswer();
  await pc.setLocalDescription(answerDesc);
  await roomRef.child('answer').set(answerDesc.toJSON());

  // گوش دادن به offerCandidates (اگر قبل از اتصال ارسالی شده باشند)
  roomRef.child('offerCandidates').on('child_added', snap => {
    const c = snap.val();
    if(c) pc.addIceCandidate(c).catch(console.error);
  });

  // ارسال candidate های خود به answerCandidates
  roomRef.child('answerCandidates').on('child_added', snap => {
    // optional handling
  });

  // گوش بده برای candidate های initiator (در صورت اضافه شدن بعدی)
  roomRef.child('offerCandidates').on('child_added', snap => {
    const c = snap.val();
    if(c) pc.addIceCandidate(c).catch(console.error);
  });

  // وقتی آماده شد
  setupDC();

  logStatus('connected? waiting...');
  chatSection.style.display = 'block';
  appendMessage('شما به روم پیوستید. در انتظار وصل شدن کانال...', 'me');
};

/* گوش دادن به candidateها برای initiator بعد از اینکه receiver جوابی گذاشت */
if(true){
  // Initiator should also subscribe to answerCandidates if it later exists.
  // This subscription is set up after createBtn creates roomRef.
  // For safety, set a periodic attach if roomRef already exists.
  // We'll attach handler on createBtn and on successful join.
}

/* ارسال/نمایش پیام چت */
document.getElementById('send').onclick = () => {
  const v = document.getElementById('txt').value.trim();
  if(!v) return;
  if(!dc || dc.readyState !== 'open'){ alert('کانال باز نیست'); return; }
  const payload = { name: document.getElementById('name').value.trim() || 'me', msg: v };
  dc.send(JSON.stringify(payload));
  appendMessage(payload.name + ': ' + payload.msg, 'me');
  document.getElementById('txt').value = '';
};

/* اضافه کردن listener های candidate بعد از اینکه roomRef تعریف شد */
function attachCandidateListeners(){
  if(!roomRef) return;
  // initiator listens for answerCandidates (others push)
  roomRef.child('answerCandidates').on('child_added', snap => {
    const c = snap.val();
    if(c) pc.addIceCandidate(c).catch(console.error);
  });
  // receiver listens for offerCandidates (already added)
  roomRef.child('offerCandidates').on('child_added', snap => {
    const c = snap.val();
    if(c) pc.addIceCandidate(c).catch(console.error);
  });
}

// هر بار که roomRef ست شد، listener ها رو وصل کن
const origCreateBtn = document.getElementById('createBtn');
const wrappedCreate = origCreateBtn.onclick;
origCreateBtn.onclick = async function(evt){
  await wrappedCreate.call(this, evt);
  attachCandidateListeners();
};
// joinBtn هم بسته‌بندی کن
const origJoinBtn = document.getElementById('joinBtn');
const wrappedJoin = origJoinBtn.onclick;
origJoinBtn.onclick = async function(evt){
